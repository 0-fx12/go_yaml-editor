<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAML配置查看器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .content { padding: 30px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .search-box { flex: 1; min-width: 300px; position: relative; }
        .search-box input { width: 100%; padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; }
        .search-box input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { background: #4f46e5; color: white; border: none; padding: 10px 18px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .btn:hover { background: #4338ca; transform: translateY(-1px); }
        .btn.secondary { background: #0ea5e9; }
        .btn.secondary:hover { background: #0284c7; }
        .stats { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; flex: 1; min-width: 150px; text-align: center; }
        .stat-number { font-size: 1.4rem; font-weight: 700; color: #4f46e5; margin-bottom: 4px; }
        .stat-label { color: #64748b; font-size: 0.9rem; }
        .table-container { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
        .table td { padding: 12px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        .table tr:hover { background: #f9fafb; }
        .field-path { font-family: 'Monaco', 'Menlo', monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; color: #1e293b; }
        .field-value { max-width: 300px; word-break: break-all; }
        .field-type { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
        .type-string { background: #dbeafe; color: #1e40af; }
        .type-number { background: #dcfce7; color: #166534; }
        .type-boolean { background: #fef3c7; color: #92400e; }
        .type-array { background: #f3e8ff; color: #7c3aed; }
        .type-object { background: #fce7f3; color: #be185d; }
        .editable { width: 260px; }
        .input { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .input.changed { background: #fff7ed; border-color: #f59e0b; }
        .row-actions { display: flex; gap: 8px; }
        .loading { text-align: center; padding: 30px; color: #6b7280; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .empty { text-align: center; padding: 40px 20px; color: #6b7280; }
        .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
        @media (max-width: 768px) { .container { margin: 10px; border-radius: 12px; } .content { padding: 20px; } .controls { flex-direction: column; align-items: stretch; } .search-box { min-width: auto; } .table-container { overflow-x: auto; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 YAML配置查看器</h1>
            <p>解析并展示YAML配置文件内容，可在右侧编辑一列修改后统一保存</p>
        </div>
        
        <div class="content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索字段路径或值..." />
                </div>
                <div class="row-actions">
                    <button class="btn secondary" onclick="loadData(currentPage)">🔄 刷新</button>
                    <button class="btn" onclick="saveAll()">💾 保存修改</button>
                </div>
            </div>

            <div id="error" class="error" style="display:none;"></div>

            <div id="stats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalFields">0</div>
                    <div class="stat-label">总字段数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentPage">1</div>
                    <div class="stat-label">当前页</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPages">1</div>
                    <div class="stat-label">总页数</div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div>正在加载YAML数据...</div>
            </div>

            <div id="content" style="display: none;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>字段路径</th>
                                <th>原始值</th>
                                <th>类型</th>
                                <th style="width:260px;">可修改值</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div id="pagination" class="pagination"></div>
            </div>

            <div id="empty" class="empty" style="display: none;">
                <div class="empty-icon">📄</div>
                <div>没有找到YAML数据</div>
                <div style="margin-top: 10px; font-size: 0.9rem;">请确保在程序目录下有 config.yaml、sample_config.yaml 或 test.yaml 文件</div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let totalFields = 0;
        // 记录被修改的路径和值
        const pendingUpdates = new Map(); // path -> value

        document.addEventListener('DOMContentLoaded', function() {
            loadData(1);
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterData(e.target.value);
            });
        });

        async function loadData(page = 1) {
            showLoading(); hideError();
            try {
                const res = await fetch(`/api/v1/yaml?page=${page}&size=${pageSize}`);
                if (!res.ok) throw new Error('获取数据失败: ' + res.status);
                const result = await res.json();
                if (result.message !== 'success') throw new Error(result.message || '未知错误');
                currentData = result.data.fields;
                filteredData = [...currentData];
                currentPage = result.data.page;
                totalPages = result.data.totalPage;
                totalFields = result.data.total;
                updateStats(result.data);
                renderTable();
                renderPagination();
                showContent();
            } catch (e) {
                showError(e.message); showEmpty();
            }
        }

        function filterData(term) {
            if (!term.trim()) {
                filteredData = [...currentData];
            } else {
                const t = term.toLowerCase();
                filteredData = currentData.filter(f => f.path.toLowerCase().includes(t) || String(f.value).toLowerCase().includes(t));
            }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const pageData = filteredData.slice(0, pageSize);
            tbody.innerHTML = pageData.map(field => {
                const path = field.path;
                const original = field.value;
                const current = pendingUpdates.has(path) ? pendingUpdates.get(path) : original;
                const changed = JSON.stringify(current) !== JSON.stringify(original);
                return `
                    <tr>
                        <td><span class="field-path">${escapeHtml(path)}</span></td>
                        <td class="field-value">${formatValue(original)}</td>
                        <td><span class="field-type type-${field.type}">${field.type}</span></td>
                        <td class="editable">${renderEditor(field, current, changed)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderEditor(field, value, changed) {
            const baseClass = changed ? 'input changed' : 'input';
            const escPath = encodeURIComponent(field.path);
            switch (field.type) {
                case 'boolean':
                    const checked = String(value) === 'true' || value === true ? 'checked' : '';
                    return `<label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" ${checked} onchange="onEdit('${escPath}', this.checked)">
                        <span>${checked ? 'true' : 'false'}</span>
                    </label>`;
                case 'number':
                    return `<input class="${baseClass}" type="number" value="${escapeAttr(value)}" onchange="onNumberEdit('${escPath}', this.value)">`;
                case 'array':
                case 'object':
                    return `<textarea class="${baseClass}" rows="2" placeholder="以JSON格式编辑" onchange="onJSONEdit('${escPath}', this.value)">${escapeHtml(JSON.stringify(value))}</textarea>`;
                default:
                    return `<input class="${baseClass}" type="text" value="${escapeAttr(value)}" onchange="onEdit('${escPath}', this.value)">`;
            }
        }

        function onEdit(encodedPath, newValue) {
            const path = decodeURIComponent(encodedPath);
            pendingUpdates.set(path, newValue);
            renderTable();
        }
        function onNumberEdit(encodedPath, newValue) {
            const path = decodeURIComponent(encodedPath);
            if (newValue === '' || isNaN(Number(newValue))) {
                pendingUpdates.set(path, newValue);
            } else {
                pendingUpdates.set(path, Number(newValue));
            }
            renderTable();
        }
        function onJSONEdit(encodedPath, newValue) {
            const path = decodeURIComponent(encodedPath);
            try {
                const parsed = JSON.parse(newValue);
                pendingUpdates.set(path, parsed);
            } catch (_) {
                pendingUpdates.set(path, newValue);
            }
            renderTable();
        }

        async function saveAll() {
            if (pendingUpdates.size === 0) { alert('没有需要保存的修改'); return; }
            const updates = {};
            for (const [k, v] of pendingUpdates.entries()) { updates[k] = v; }
            try {
                const res = await fetch('/api/v1/yaml', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ updates }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || '保存失败');
                pendingUpdates.clear();
                alert('保存成功: ' + (data.file || ''));
                loadData(currentPage);
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }
            let html = '';
            html += `<button onclick="changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>上一页</button>`;
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'current' : ''}">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span>...</span>`;
                }
            }
            html += `<button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>下一页</button>`;
            pagination.innerHTML = html;
        }

        function changePage(page) { if (page < 1 || page > totalPages) return; loadData(page); }
        function updateStats(data) { document.getElementById('totalFields').textContent = data.total; document.getElementById('currentPage').textContent = data.page; document.getElementById('totalPages').textContent = data.totalPage; document.getElementById('stats').style.display = 'flex'; }
        function formatValue(value) { if (value === null || value === undefined) return '<em style="color:#9ca3af;">null</em>'; if (typeof value === 'string') return escapeHtml(value); if (typeof value === 'boolean') return value ? '✅ true' : '❌ false'; if (typeof value === 'number') return `<strong>${value}</strong>`; if (Array.isArray(value)) return `<span style="color:#7c3aed;">[数组，长度: ${value.length}]</span>`; if (typeof value === 'object') return `<span style="color:#be185d;">{对象}</span>`; return escapeHtml(String(value)); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function escapeAttr(val) { if (val === null || val === undefined) return ''; return String(val).replace(/"/g, '&quot;'); }
        function showLoading() { document.getElementById('loading').style.display = 'block'; document.getElementById('content').style.display = 'none'; document.getElementById('empty').style.display = 'none'; }
        function showContent() { document.getElementById('loading').style.display = 'none'; document.getElementById('content').style.display = 'block'; document.getElementById('empty').style.display = 'none'; }
        function showEmpty() { document.getElementById('loading').style.display = 'none'; document.getElementById('content').style.display = 'none'; document.getElementById('empty').style.display = 'block'; }
        function showError(message) { const e = document.getElementById('error'); e.textContent = message; e.style.display = 'block'; }
        function hideError() { document.getElementById('error').style.display = 'none'; }
    </script>
</body>
</html>

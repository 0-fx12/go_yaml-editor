# 超简单的Go应用Dockerfile
FROM golang:1.22-alpine

# 设置工作目录
WORKDIR /app

# 设置Go代理和编译优化（使用官方代理）
ENV GOPROXY=https://proxy.golang.org,direct
ENV GOSUMDB=off
ENV GOMAXPROCS=4

# 先复制依赖文件，利用Docker缓存
COPY go.mod go.sum ./
# RUN go mod download  # 本地已下载，跳过此步骤

# 再复制源代码
COPY . .

# 编译应用（去掉mod=readonly，允许下载依赖）
RUN echo "开始编译..." && \
    CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o main main.go && \
    echo "编译完成，文件大小:" && \
    ls -lh main

# 暴露端口
EXPOSE 8080

# 直接运行
CMD ["./main"]
